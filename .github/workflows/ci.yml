name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  run-ci:
    uses: IngsisPrintScript/workflows-and-actions/.github/workflows/printscript-ci.yaml@main
    with:
      java-version: "21"

  get-coverage:
    needs: run-ci
    runs-on: ubuntu-latest
    steps:
      - name: Download Jacoco report artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Print where it is
        run: |
          echo "Jacoco reports downloaded to coverage/" >> $GITHUB_STEP_SUMMARY

      - name: Merge module coverage reports into single folder
        run: |
          mkdir -p merged-coverage
          for dir in $(find coverage -path "*/build/custom-reports/jacoco/html" -type d); do
            module=$(echo "$dir" | sed 's#coverage/\([^/]*\)/.*#\1#')
            echo "Merging coverage for module: $module"
            mkdir -p "merged-coverage/$module"
            cp -R "$dir/" "merged-coverage/$module/"
          done

      - name: Zip merged coverage
        run: |
          zip -r merged-coverage.zip merged-coverage

      - name: Upload merged coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: merged-coverage
          path: merged-coverage.zip

      - name: Add coverage info to PR summary
        run: |
          echo "## Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A consolidated **ZIP with all HTML coverage reports** has been generated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download the artifact named \`merged-coverage\` above in the Actions UI.**" >> $GITHUB_STEP_SUMMARY
