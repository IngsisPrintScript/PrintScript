name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  run-ci:
    uses: IngsisPrintScript/workflows-and-actions/.github/workflows/printscript-ci.yaml@main
    with:
      java-version: "21"

  get-coverage:
    needs: run-ci
    runs-on: ubuntu-latest
    steps:
      - name: Download Jacoco report artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Print where it is
        run: |
          echo "Jacoco reports downloaded to coverage/" >> $GITHUB_STEP_SUMMARY

      - name: Merge module coverage reports into single folder
        run: |
          mkdir -p merged-coverage
          for dir in coverage/**/jacocoHtml; do
            module=$(basename $(dirname $dir))
            echo "Copying coverage for module: $module"
            mkdir -p "merged-coverage/$module"
            cp -R "$dir/" "merged-coverage/$module/"
          done

      - name: Add coverage links to PR summary
        run: |
          echo "## Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for moduleDir in merged-coverage/*; do
            module=$(basename "$moduleDir")
            echo "- [$module Coverage]($moduleDir/index.html)" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload merged coverage for debugging (optional)
        uses: actions/upload-artifact@v4
        with:
          name: merged-coverage
          path: merged-coverage
